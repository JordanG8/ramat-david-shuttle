// ═══════════════════════════════════════════
// RAMAT DAVID SHUTTLE — APP
// ═══════════════════════════════════════════

let DATA = {
  title: "מקרא תחנות הכנף",
  legend: {
    תחנת_שירות: "תחנה ששאטל עוצר בה (ירוק)",
    תחנה_חלופית: "תחנה שממנה נדרש להגיע לתחנת שירות (צהוב)",
  },
  units: [
    {
      name: "טייסת 109",
      departments: [
        { name: 'דת"ק 13', type: "תחנת שירות" },
        { name: 'דת"ק 16', type: "תחנת שירות" },
        { name: 'דת"ק 12', type: "תחנת שירות" },
        { name: 'דת"ק 15', type: "תחנה חלופית", goes_to: "גף טיסה 109" },
        { name: 'דת"ק 8', type: "תחנת שירות" },
        { name: "גף טיסה", type: "תחנת שירות" },
        { name: "גף טכני", type: "תחנת שירות" },
      ],
    },
    {
      name: "טייסת 160",
      station: "רחבת היסעים",
      departments: [
        { name: "גף טיסה", type: "תחנת שירות" },
        { name: "גף טכני", type: "תחנת שירות" },
      ],
    },
    {
      name: "טייסת 105",
      departments: [
        { name: 'דת"ק 14', type: "תחנה חלופית", goes_to: 'דת"ק 34' },
        { name: 'דת"ק 9', type: "תחנת שירות" },
        { name: 'דת"ק 7', type: "תחנת שירות" },
        { name: 'דת"ק 2', type: "תחנת שירות" },
        { name: "גף טיסה", type: "תחנת שירות" },
        { name: "גף טכני", type: "תחנת שירות" },
      ],
    },
    {
      name: "טייסת 144",
      departments: [
        { name: "מפקדה", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: 'דת"ק 32', type: "תחנת שירות" },
        { name: "בריטניה", type: "תחנת שירות" },
      ],
    },
    {
      name: "טייסת 101",
      station: "רחבת היסעים",
      departments: [
        { name: 'דת"ק 17', type: "תחנת שירות" },
        { name: 'דת"ק 5', type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: 'דת"ק 4', type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: 'דת"ק 3', type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "גף טיסה", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "גף טכני", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
      ],
    },
    {
      name: "טייסת תעופה",
      station: "רחבת היסעים",
      departments: [
        { name: "מגדל", type: "תחנת שירות" },
        { name: "מפקדה", type: "תחנת שירות" },
        { name: "אבטחת מידע", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "אבטחה פיזית", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "כיבוי", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        {
          name: 'רציפו"ת תפקודית',
          type: "תחנה חלופית",
          goes_to: "רחבת היסעים",
        },
        { name: 'מושל"ם', type: "תחנת שירות" },
      ],
    },
    {
      name: "בינוי 302",
      station: "רחבת היסעים",
      departments: [
        { name: "מפקדה", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "מערכות חשמל", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "משאבים/רכב", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "מערכות מיזוג", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: 'מש"ק', type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "הנדסה", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        {
          name: 'מערכות דס"ל/דלק 21',
          type: "תחנה חלופית",
          goes_to: "רחבת היסעים",
        },
        { name: "שירותי קרקע", type: "תחנת שירות" },
      ],
    },
    {
      name: "לשכה",
      station: "רחבת היסעים",
      departments: [
        { name: "לשכת כנף 1", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "בטיחות", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        {
          name: "משרד סוציולוגית",
          type: "תחנה חלופית",
          goes_to: "רחבת היסעים",
        },
      ],
    },
    {
      name: "מנהלה",
      station: "רחבת היסעים",
      departments: [
        {
          name: "כח אדם חובה/סגל",
          type: "תחנה חלופית",
          goes_to: "רחבת היסעים",
        },
        { name: "לוגיסטיקה", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "רבנות", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: 'רס"ר', type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "רפואה", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "פסיכולוגיה", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: 'שפ"ו', type: "תחנה חלופית", goes_to: "רחבת היסעים" },
        { name: "תזונה", type: "תחנה חלופית", goes_to: "רחבת היסעים" },
      ],
    },
    {
      name: "טייסת תחזוקה",
      notes: "רכבות - איסוף מתחנת מערכות",
      notes2: 'חד"א - מעבר בכלל התחנות',
      departments: [
        { name: "מרכז אחזקה", type: "תחנת שירות" },
        { name: "מנועים", type: "תחנה חלופית" },
        { name: "מערכות", type: "תחנה חלופית" },
        { name: "מוסכים א/ב", type: "תחנה חלופית" },
        { name: "אוהד", type: "תחנה חלופית" },
        { name: 'גל"א', type: "תחנה חלופית" },
        { name: "אוויוניקה", type: "תחנה חלופית" },
        { name: "מבנה", type: "תחנה חלופית" },
        { name: "תקשוב", type: "תחנה חלופית" },
        { name: "חילוץ", type: "תחנה חלופית" },
        { name: 'נשמ"ת', type: "תחנת שירות" },
        { name: "מרכז בידונים", type: "תחנת שירות" },
      ],
    },
  ],
  bus_routes: [
    {
      name: "בסיס - רכבת",
      description: "תחנות עצירה מהבסיס לרכבת",
      stops: [
        "רחבת היסעים",
        "מערכות (איסוף מרכז של תחנות תחזוקה-מפורט במקרא)",
        'דת"ק 16',
        'דת"ק 13',
        'דת"ק 12',
        "גף טכני 160",
        'דת"ק 7',
        'דת"ק 8',
        "דלק 21",
        'נשמ"ת',
        "גף טכני 109",
        "גף טיסה 109",
      ],
      departure_times: [
        { time: "07:20" },
        { time: "08:20" },
        { time: "09:20", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "10:20", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "12:30", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "13:35", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "14:30" },
        { time: "14:50", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "15:30" },
        { time: "15:50", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "16:30" },
        { time: "16:50", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "17:15" },
      ],
    },
    {
      name: "רכבת - בסיס",
      description: "תחנות עצירה מהרכבת לבסיס",
      stops: [
        "רכבת כפר יהושע",
        "גף טכני 109",
        "גף טיסה 109",
        'נשמ"ת',
        'דת"ק 7',
        'דת"ק 8',
        "דלק 21",
        "גף טכני 160",
        'דת"ק 12',
        'דת"ק 13',
        'דת"ק 16',
        "שירותי קרקע",
        "גף אוהד",
        'גל"א',
        "גף אוויוניקה",
        "גף מבנה",
        "מרכז אחזקה",
        "מוסכים א/ב",
        "מנועים",
        "חילוץ",
        "רחבת היסעים",
        "קולנוע",
        'דת"ק 17',
        'דת"ק 2',
        "גף טיסה 105",
        "גף טכני 105",
        "מתחם בידונים",
        "מגדל",
        'דת"ק 34',
        'דת"ק 32',
        'דת"ק 9',
        "בריטניה",
        "רחבת היסעים",
      ],
      departure_times: [
        { time: "07:40" },
        { time: "08:40" },
        { time: "09:40", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "10:40", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "13:00", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "14:05", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "14:45" },
        { time: "15:20", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "16:10" },
        { time: "16:30", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "17:10" },
        { time: "17:30", note: "תגבור- רק בימי ראשון וחמישי" },
        { time: "18:00" },
      ],
    },
    {
      name: "פיזור נוסף למקומות העבודה",
      description: "פיזור נוסף למקומות העבודה",
      note: "איסוף ממקומות העבודה בשעה בסוף יום בשעה 17:15",
      sub_routes: [
        {
          name: "פיזור למקומות עבודה - מסלול 105",
          departure_times_str:
            "7:20-7:40-08:30-09:30-10:00-10:15-14:10-14:40-15:10-16:10-16:50-17:15",
          stops: [
            "קולנוע",
            'דת"ק 17',
            'דת"ק 2',
            "גף טיסה 105",
            "גף טכני 105",
            "מתחם בידונים",
            "מגדל",
            'דת"ק 34',
            'דת"ק 32',
            'דת"ק 9',
            "בריטניה",
            "רחבת היסעים",
          ],
        },
        {
          name: "פיזור למקומות עבודה - מסלול 109",
          departure_times_str:
            "7:20-8:20-09:00-10:00-10:30-11:00-12:10-12:40-13:10-14:10-14:40-15:10-15:40-16:10-16:40",
          stops: [
            "רחבת היסעים",
            "מערכות (איסוף מרכז של תחנות תחזוקה-מפורט במקרא)",
            'דת"ק 16',
            'דת"ק 13',
            'דת"ק 12',
            "גף טכני 160",
            'דת"ק 7',
            'דת"ק 8',
            "דלק 21",
            'נשמ"ת',
            "גף טכני 109",
            "גף טיסה 109",
            "רחבת היסעים",
          ],
        },
      ],
    },
    {
      name: "צומת - בסיס",
      description: "שאטל צומת רמת דוד לבסיס",
      stops: ["צומת רמת דוד", "רחבת היסעים"],
      departure_times_str:
        "08:00-8:30-09:00-09:30-10:00-10:30-11:00-12:10-12:40-13:10-14:10-14:40-15:10-15:40-16:10-16:40",
      evening: {
        time: "18:00-22:00",
        break: "הפסקה 20:40-21:00",
      },
    },
  ],
};

// ─── Old Routes Data (full schedule from wing_stations) ───
let OLD_ROUTES = [
  {
    name: "קו 1 - ראשון עד חמישי",
    phone: "",
    schedule: [
      {
        time: "6:00-7:00",
        type: "איסוף",
        description: 'איסוף ע"פ קריאה מול מוצב מנהלה',
      },
      {
        time: "7:20",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "מגדל",
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "7:40",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "מגדל",
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "8:00",
        type: "נסיעה",
        stops: ["רחבת היסעים", "צומת הנת דוד", 'ש"ג קדמי'],
      },
      {
        time: "8:20",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'דת"ק 16',
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "8:40",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          "מגדל",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      { time: "9:20-10:00", type: "הפסקה" },
      {
        time: "10:00",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "מגדל",
          "גף טכני 105",
          "גף טיסה 105",
          "מתחם בידונים",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "10:30",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'דת"ק 16',
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
        ],
      },
      {
        time: "11:00",
        type: "נסיעה",
        stops: [
          "גף טיסה 109",
          "גף טכני 109",
          'נשמ"ת',
          'דת"ק 8',
          'דת"ק 7',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          'חד"א',
        ],
      },
      {
        time: "11:20",
        type: "נסיעה",
        stops: [
          "גף טיסה 109",
          "גף טכני 109",
          'נשמ"ת',
          'דת"ק 8',
          'דת"ק 7',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          'חד"א',
        ],
      },
      { time: "11:30-12:00", type: "הפסקה" },
      {
        time: "12:05",
        type: "נסיעה",
        stops: [
          'חד"א',
          "גף מנועים",
          "גף מערכות",
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "חילוץ",
          'חד"א',
        ],
      },
      {
        time: "12:20",
        type: "נסיעה",
        stops: [
          'חד"א',
          "רחבת היסעים",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          "דלק 21",
          'דת"ק 7',
          'דת"ק 8',
          'נשמ"ת',
          "גף טיסה 109",
          "גף טכני 109",
          'חד"א',
        ],
      },
      {
        time: "13:00",
        type: "נסיעה",
        stops: [
          'חד"א',
          "גף מנועים",
          "גף מערכות",
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "חילוץ",
        ],
      },
      {
        time: "13:30",
        type: "נסיעה",
        stops: [
          'חד"א',
          "רחבת היסעים",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          "דלק 21",
          'דת"ק 7',
          'דת"ק 8',
          'נשמ"ת',
          "גף טיסה 109",
          "גף טכני 109",
        ],
      },
      { time: "13:45-14:30", type: "הפסקה" },
      {
        time: "14:30",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'דת"ק 16',
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "14:45",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          "מגדל",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "15:30",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'דת"ק 16',
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "16:10",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          "מגדל",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "16:30",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'דת"ק 16',
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "17:10",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
        ],
      },
      { time: "18:00", type: "סוף יום" },
    ],
  },
  {
    name: "קו 2 - ראשון עד חמישי",
    phone: "",
    schedule: [
      {
        time: "6:30-7:00",
        type: "איסוף",
        description: 'איסוף ע"פ קריאה מול מוצב מנהלה',
      },
      {
        time: "7:20",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'דת"ק 16',
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "7:40",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          "מגדל",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "8:30",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "מגדל",
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
          "צומת רמת דוד",
        ],
      },
      {
        time: "9:00",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      {
        time: "9:30",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "מגדל",
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
          "צומת רמת דוד",
        ],
      },
      {
        time: "10:15",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "מגדל",
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
        ],
      },
      { time: "10:30-11:00", type: "הפסקה" },
      {
        time: "11:00",
        type: "נסיעה",
        stops: [
          "בריטניה",
          'דת"ק 9',
          'דת"ק 32',
          'דת"ק 34',
          "מגדל",
          "מתחם בידונים",
          'דת"ק 2',
          'דת"ק 17',
          'חד"א',
        ],
      },
      {
        time: "11:20",
        type: "נסיעה",
        stops: [
          'חד"א',
          "גף מנועים",
          "מתחם בידונים",
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "חילוץ",
          'חד"א',
        ],
      },
      { time: "11:30-12:00", type: "הפסקה" },
      {
        time: "12:10",
        type: "נסיעה",
        stops: [
          'חד"א',
          "רחבת היסעים",
          'דת"ק 17',
          'דת"ק 2',
          "מתחם בידונים",
          "גף טכני 105",
          "גף טיסה 105",
          "מגדל",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
        ],
      },
      {
        time: "12:20",
        type: "נסיעה",
        stops: [
          "בריטניה",
          'דת"ק 9',
          'דת"ק 32',
          'דת"ק 34',
          "מגדל",
          "מתחם בידונים",
          'דת"ק 2',
          'דת"ק 17',
          'חד"א',
        ],
      },
      { time: "12:30-13:15", type: "הפסקה" },
      {
        time: "13:20",
        type: "נסיעה",
        stops: [
          'חד"א',
          "רחבת היסעים",
          'דת"ק 17',
          'דת"ק 2',
          "מתחם בידונים",
          "גף טכני 105",
          "גף טיסה 105",
          "מגדל",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
        ],
      },
      {
        time: "14:10",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "מגדל",
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "14:40",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "מגדל",
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "15:10",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "מגדל",
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      { time: "15:40-16:10", type: "הפסקה" },
    ],
  },
  {
    name: "קו 3 - ראשון עד חמישי",
    phone: "",
    schedule: [
      {
        time: "10:00",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      {
        time: "10:30",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      {
        time: "11:00",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      { time: "11:30-12:00", type: "הפסקה" },
      {
        time: "12:10",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      {
        time: "12:40",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      {
        time: "13:10",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      { time: "13:40-14:00", type: "הפסקה" },
      {
        time: "14:10",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      {
        time: "14:40",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      {
        time: "15:10",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      {
        time: "15:40",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      {
        time: "16:10",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      {
        time: "16:40",
        type: "נסיעה",
        stops: [
          "צומת רמת דוד",
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "צומת רמת דוד",
        ],
      },
      { time: "17:30-18:00", type: "הפסקה" },
      {
        time: "18:00-20:40",
        type: "איסוף",
        description: 'איסוף ע"פ קריאה מול מוצב מנהלה',
      },
      { time: "20:40-21:00", type: "הפסקה" },
      {
        time: "21:00-21:45",
        type: "איסוף",
        description: 'איסוף ע"פ קריאה מול מוצב מנהלה',
      },
      { time: "22:00", type: "סוף יום" },
    ],
  },
  {
    name: "קו 4 - תגבור רכבות ראשון וחמישי",
    schedule: [
      {
        time: "7:20",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "7:40",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          "מגדל",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "8:20",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "8:40",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          "מגדל",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "9:20",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "9:40",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          "מגדל",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      {
        time: "10:20",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
          'נשמ"ת',
        ],
      },
      {
        time: "10:40",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
          "קולנוע",
          'דת"ק 17',
          'דת"ק 2',
          "גף טיסה 105",
          "גף טכני 105",
          "מתחם בידונים",
          "מגדל",
          'דת"ק 34',
          'דת"ק 32',
          'דת"ק 9',
          "בריטניה",
          "רחבת היסעים",
        ],
      },
      { time: "11:30-12:30", type: "הפסקה" },
      {
        time: "12:30",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "13:00",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
        ],
      },
      {
        time: "13:35",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "14:05",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
        ],
      },
      { time: "14:20-14:45", type: "הפסקה" },
      {
        time: "14:50",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "15:20",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
        ],
      },
      {
        time: "15:50",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "16:30",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
        ],
      },
      {
        time: "16:50",
        type: "נסיעה",
        stops: [
          "רחבת היסעים",
          "מערכות (איסוף מרכז של תחנות תחזוקה - מפורט במקרא)",
          'דת"ק 16',
          'דת"ק 13',
          'דת"ק 12',
          "גף טכני 160",
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          'נשמ"ת',
          "גף טכני 109",
          "גף טיסה 109",
          "רכבת כפר יהושע",
        ],
      },
      {
        time: "17:30",
        type: "נסיעה",
        stops: [
          "רכבת כפר יהושע",
          "גף טכני 109",
          "גף טיסה 109",
          'נשמ"ת',
          'דת"ק 7',
          'דת"ק 8',
          "דלק 21",
          "גף טכני 160",
          'דת"ק 12',
          'דת"ק 13',
          'דת"ק 16',
          "שירותי קרקע",
          "גף אוהד",
          'גל"א',
          "גף אוויוניקה",
          "גף מבנה",
          "מרכז אחזקה",
          "מוסכים א/ב",
          "מנועים",
          "חילוץ",
          "רחבת היסעים",
        ],
      },
      { time: "סוף יום", type: "סוף יום" },
    ],
  },
];

// ─── Load Admin Overrides from localStorage ───
(function applyAdminOverrides() {
  try {
    const saved = localStorage.getItem("shuttle_admin_data");
    if (!saved) return;
    const d = JSON.parse(saved);
    if (d.units) DATA.units = d.units;
    if (d.bus_routes) DATA.bus_routes = d.bus_routes;
    if (d.old_routes) OLD_ROUTES = d.old_routes;
  } catch (e) {
    console.warn("Admin override load failed:", e);
  }
})();

// ─── Helpers ───
function esc(str) {
  const div = document.createElement("div");
  div.textContent = str;
  return div.innerHTML.replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}

const chevronSVG = `<svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>`;
const smallChevronSVG = `<svg class="tl-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>`;
const arrowSVG = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`;

// ─── Render Stations ───
function renderStationsHtml() {
  return DATA.units
    .map((unit) => {
      const deptCount = unit.departments.length;
      const noteIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`;
      let noteHtml = unit.notes
        ? `<div class="unit-note">${noteIcon}${esc(unit.notes)}</div>`
        : "";
      if (unit.notes2) {
        noteHtml += `<div class="unit-note">${noteIcon}${esc(unit.notes2)}</div>`;
      }

      const deptsHtml = unit.departments
        .map((dept) => {
          const isService = dept.type === "תחנת שירות";
          const dotClass = isService ? "service" : "alt";
          const goesTo = dept.goes_to
            ? `<span class="dept-goes-to">${arrowSVG} ${esc(dept.goes_to)}</span>`
            : "";
          return `
        <div class="dept-item">
          <div class="dept-info">
            <span class="dept-dot ${dotClass}"></span>
            <span class="dept-name">${esc(dept.name)}</span>
          </div>
          ${goesTo}
        </div>`;
        })
        .join("");

      const colorStyle = unit.color
        ? `style="border-right:4px solid ${esc(unit.color)}"`
        : "";
      const headerColorStyle = unit.color
        ? `style="border-left-color:${esc(unit.color)}"`
        : "";

      return `
      <div class="unit-card" ${colorStyle}>
        <div class="unit-header" onclick="this.parentElement.classList.toggle('open')">
          <div class="unit-title">
            ${unit.color ? `<span class="unit-color-dot" style="background:${esc(unit.color)}"></span>` : ""}
            ${esc(unit.name)}
            <span class="unit-count">${deptCount}</span>
          </div>
          <div class="unit-meta">
            ${chevronSVG}
          </div>
        </div>
        <div class="unit-body">
          ${noteHtml}
          <div class="dept-list">
            ${deptsHtml}
          </div>
        </div>
      </div>`;
    })
    .join("");
}

// ─── Hub-and-Spoke State ───
let currentView = "home"; // "home" | "train" | "tzomet" | "internal" | "hada" | "oncall" | "info"
let highlightTime = null;

// ─── Icons ───
const clockSVG = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`;
const mapPinSVG = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`;
const moonSVG = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`;
const infoSVG = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`;

function renderStopsCard(stops) {
  const stopsHtml = stops
    .map(
      (stop, i) =>
        `<div class="stop-item"><span class="stop-num">${i + 1}</span>${esc(stop)}</div>`,
    )
    .join("");
  return `
    <div class="card-block stops-block-static">
      <div class="card-block-header static">
        <div class="card-block-title">${mapPinSVG} תחנות עצירה</div>
      </div>
      <div class="stops-list">
        ${stopsHtml}
      </div>
    </div>`;
}

const reinforceSVG = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg>`;

function isTimePassed(timeStr) {
  const match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
  if (!match) return false;
  const now = new Date();
  const nowMins = now.getHours() * 60 + now.getMinutes();
  return parseInt(match[1]) * 60 + parseInt(match[2]) < nowMins;
}

function renderDepartureList(items, extraClass) {
  return `<div class="departure-list">
    ${items
      .map((d) => {
        const passed = isTimePassed(d.time) ? " dep-time-passed" : "";
        return `<span class="dep-time-item ${extraClass || ""} ${d.note ? "dep-time-item--reinforce" : ""}${passed}">${esc(d.time)}</span>`;
      })
      .join("")}
  </div>`;
}

function renderDepartureTable(departures, filterReinforcement, split) {
  if (split) {
    const regular = departures.filter((d) => !d.note);
    const reinforce = departures.filter((d) => !!d.note);
    let html = "";
    if (regular.length > 0) {
      html += `
        <div class="card-block times-block-compact">
          <div class="card-block-header static">
            <div class="card-block-title">${clockSVG} שעות יציאה <span class="estimated-tag">משוערות</span></div>
          </div>
          ${renderDepartureList(regular)}
        </div>`;
    }
    if (reinforce.length > 0) {
      const reinforceOpen = isReinforcementDay() ? " open" : "";
      html += `
        <div class="card-block times-block-compact times-block--reinforce${reinforceOpen}" onclick="this.classList.toggle('open')">
          <div class="card-block-header reinforce-header">
            <div class="card-block-title">${reinforceSVG} תגבור ראשון וחמישי <span class="estimated-tag">משוער</span></div>
            <div class="card-block-meta">${smallChevronSVG}</div>
          </div>
          <div class="card-block-body">
            ${renderDepartureList(reinforce, "dep-time-item--reinforce")}
          </div>
        </div>`;
    }
    return html;
  }

  const filtered = departures.filter((d) => {
    const isReinforcement = !!d.note;
    if (filterReinforcement === "only") return isReinforcement;
    if (filterReinforcement === "none") return !isReinforcement;
    return true;
  });
  if (filtered.length === 0) return '<div class="no-data">אין שעות יציאה</div>';

  return `
    <div class="card-block times-block-compact">
      <div class="card-block-header static">
        <div class="card-block-title">${clockSVG} שעות יציאה <span class="estimated-tag">משוערות</span></div>
      </div>
      ${renderDepartureList(filtered)}
    </div>`;
}

function renderDepartureTimesStr(timesStr) {
  const times = timesStr.split("-");
  return `
    <div class="card-block times-block-compact">
      <div class="card-block-header static">
        <div class="card-block-title">${clockSVG} שעות יציאה <span class="estimated-tag">משוערות</span></div>
      </div>
      <div class="departure-list">
        ${times
          .map((t) => {
            const passed = isTimePassed(t.trim()) ? " dep-time-passed" : "";
            return `<span class="dep-time-item${passed}">${esc(t)}</span>`;
          })
          .join("")}
      </div>
    </div>`;
}

function renderRouteCard(route, opts) {
  opts = opts || {};
  const filterReinforcement = opts.filterReinforcement || "all";
  const titleOverride = opts.title;
  const hideStops = opts.hideStops;

  let bodyHtml = "";

  if (route.departure_times) {
    bodyHtml += renderDepartureTable(
      route.departure_times,
      filterReinforcement,
      opts.splitReinforcement,
    );
  }

  if (route.departure_times_str) {
    bodyHtml += renderDepartureTimesStr(route.departure_times_str);
  }

  if (route.stops && !hideStops) {
    bodyHtml += renderStopsCard(route.stops);
  }

  if (route.note) {
    bodyHtml += `<div class="route-note">${infoSVG} ${esc(route.note)}</div>`;
  }

  if (route.evening && !opts.hideEvening) {
    bodyHtml += `
      <div class="card-block evening-block">
        <div class="card-block-header static">
          <div class="card-block-title">${moonSVG} ערב <span class="estimated-tag">משוער</span></div>
        </div>
        <div class="evening-info">
          <div class="dep-chip dep-chip--evening">
            <span class="dep-chip-time">${esc(route.evening.time)}</span>
          </div>
          <div class="evening-note">${esc(route.evening.break)}</div>
        </div>
      </div>`;
  }

  const name = titleOverride || route.name;
  const titleHtml = formatRouteTitle(name);

  const countdownHtml = renderCountdownBanner(route);

  return `
    <div class="route-card">
      <div class="route-card-header">
        <div class="route-card-title">${titleHtml}</div>
      </div>
      ${countdownHtml}
      <div class="route-card-body">
        ${bodyHtml}
      </div>
    </div>`;
}

function isReinforcementDay() {
  const day = new Date().getDay(); // 0=Sun, 4=Thu
  return day === 0 || day === 4;
}

function isReinforcementTime(d) {
  return d.note && d.note.includes("ראשון");
}

function getAllDepartureTimes(route) {
  const times = [];
  const reinforceDay = isReinforcementDay();
  if (route.departure_times) {
    route.departure_times.forEach((d) => {
      // Skip reinforcement-only times if today isn't Sunday/Thursday
      if (!reinforceDay && isReinforcementTime(d)) return;
      times.push(d.time);
    });
  }
  if (route.departure_times_str) {
    route.departure_times_str.split("-").forEach((t) => times.push(t.trim()));
  }
  if (route.sub_routes) {
    route.sub_routes.forEach((sub) => {
      if (sub.departure_times_str) {
        sub.departure_times_str.split("-").forEach((t) => times.push(t.trim()));
      }
      if (sub.departure_times) {
        sub.departure_times.forEach((d) => {
          if (!reinforceDay && isReinforcementTime(d)) return;
          times.push(d.time);
        });
      }
    });
  }
  return times;
}

function getUpcomingDepartures(route) {
  const now = new Date();
  const nowMins = now.getHours() * 60 + now.getMinutes();
  const times = getAllDepartureTimes(route);
  return getUpcomingFromTimes(times, nowMins);
}

function getUpcomingFromTimes(times, nowMins) {
  if (nowMins === undefined) {
    const now = new Date();
    nowMins = now.getHours() * 60 + now.getMinutes();
  }
  const parsed = [];
  times.forEach((t) => {
    const match = t.match(/^(\d{1,2}):(\d{2})$/);
    if (!match) return;
    const mins = parseInt(match[1]) * 60 + parseInt(match[2]);
    parsed.push({ time: t, mins });
  });
  parsed.sort((a, b) => a.mins - b.mins);
  const upcoming = [];
  for (const p of parsed) {
    const diff = p.mins - nowMins;
    if (diff >= 0 && diff <= 120) {
      upcoming.push({ time: p.time, minutes: diff });
    }
  }
  return upcoming;
}

function renderCountdownBanner(route) {
  const upcoming = getUpcomingDepartures(route);
  return renderCountdownFromUpcoming(upcoming);
}

function renderCountdownFromNext(next) {
  // Backwards compat wrapper
  if (!next) return "";
  return renderCountdownFromUpcoming([next]);
}

function formatMinutes(mins) {
  if (mins === 0) return "עכשיו!";
  if (mins <= 60) return mins + " דק׳";
  const extraMins = mins - 60;
  if (extraMins === 0) return "שעה";
  return "שעה ו" + extraMins + " דק׳";
}

function renderCountdownFromUpcoming(upcoming) {
  if (!upcoming || upcoming.length === 0) return "";

  const items = upcoming
    .map((dep) => {
      const urgent = dep.minutes <= 5;
      return `<div class="cb-item ${urgent ? "cb-item-urgent" : ""}">
      <div class="cb-item-row">
        <span class="live-dot ${urgent ? "urgent" : ""}"></span>
        <span class="cb-minutes">${formatMinutes(dep.minutes)}</span>
      </div>
      <span class="cb-time">${esc(dep.time)}</span>
    </div>`;
    })
    .join("");

  const anyUrgent = upcoming.some((d) => d.minutes <= 5);
  return `<div class="countdown-banner ${anyUrgent ? "countdown-urgent" : ""}">
    <div class="cb-label-col">
      <span class="cb-label">הקווים הקרובים</span>
      <span class="cb-disclaimer">*זמני היציאה משוערים*</span>
    </div>
    <div class="cb-items">${items}</div>
  </div>`;
}

function formatRouteTitle(name) {
  const arrowLeft = `<svg class="route-arrow" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>`;
  if (name.includes(" - ")) {
    const parts = name.split(" - ");
    return `<span class="route-from">${esc(parts[0])}</span>${arrowLeft}<span class="route-to">${esc(parts[1])}</span>`;
  }
  return esc(name);
}

// ─── Home Page Icons ───
const homeSVG = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`;
const backArrowSVG = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>`;

// ─── Get All Upcoming Departures (across all routes) ───
function getAllUpcomingDepartures() {
  const now = new Date();
  const nowMins = now.getHours() * 60 + now.getMinutes();
  const reinforceDay = isReinforcementDay();
  const entries = [];

  // Helper: parse "HH:MM" to minutes
  function parseTime(t) {
    const m = t.match(/^(\d{1,2}):(\d{2})$/);
    return m ? parseInt(m[1]) * 60 + parseInt(m[2]) : -1;
  }

  // Train: bus_routes[0] = to train, bus_routes[1] = from train
  const toTrain = DATA.bus_routes[0];
  const fromTrain = DATA.bus_routes[1];

  function addRouteEntries(route, view, routeLabel, badgeClass) {
    if (route.departure_times) {
      route.departure_times.forEach((d) => {
        if (!reinforceDay && isReinforcementTime(d)) return;
        const mins = parseTime(d.time);
        if (mins < 0) return;
        const diff = mins - nowMins;
        if (diff >= 0 && diff <= 120) {
          entries.push({
            time: d.time,
            mins,
            diff,
            view,
            routeLabel,
            badgeClass,
          });
        }
      });
    }
    if (route.departure_times_str) {
      route.departure_times_str.split("-").forEach((t) => {
        t = t.trim();
        const mins = parseTime(t);
        if (mins < 0) return;
        const diff = mins - nowMins;
        if (diff >= 0 && diff <= 120) {
          entries.push({ time: t, mins, diff, view, routeLabel, badgeClass });
        }
      });
    }
  }

  addRouteEntries(toTrain, "train", "בסיס ← רכבת", "board-badge-train");
  addRouteEntries(fromTrain, "train", "רכבת ← בסיס", "board-badge-train");

  // Tzomet: bus_routes[3]
  const tzomet = DATA.bus_routes[3];
  addRouteEntries(tzomet, "tzomet", "צומת ← בסיס", "board-badge-tzomet");

  // Internal: bus_routes[2] has sub_routes
  const internal = DATA.bus_routes[2];
  if (internal.sub_routes) {
    internal.sub_routes.forEach((sub) => {
      const label = sub.name.includes("105") ? "פנים כנף 105" : "פנים כנף 109";
      addRouteEntries(sub, "internal", label, "board-badge-internal");
    });
  }

  // Hada trips from OLD_ROUTES
  const hadaGroups = getHadaTrips();
  for (const key of Object.keys(hadaGroups)) {
    hadaGroups[key].forEach((trip) => {
      const mins = parseTime(trip.time);
      if (mins < 0) return;
      const diff = mins - nowMins;
      if (diff >= 0 && diff <= 120) {
        entries.push({
          time: trip.time,
          mins,
          diff,
          view: "hada",
          routeLabel: 'חד"א',
          badgeClass: "board-badge-hada",
        });
      }
    });
  }

  // Deduplicate by time+view (same time same route)
  const seen = new Set();
  const unique = [];
  for (const e of entries) {
    const key = e.time + "|" + e.routeLabel;
    if (!seen.has(key)) {
      seen.add(key);
      unique.push(e);
    }
  }

  unique.sort((a, b) => a.mins - b.mins);
  return unique;
}

// ─── Check if evening on-call is active ───
function isEveningOnCallActive() {
  const now = new Date();
  const h = now.getHours();
  return h >= 18 && h < 22;
}

// ─── Render Departure Board ───
function renderDepartureBoard() {
  const departures = getAllUpcomingDepartures().slice(0, 6);

  let html = `<div class="board-section">`;
  html += `<div class="board-header">
    <span class="live-dot urgent"></span>
    <span class="board-header-text">יציאות שאטלים קרובים (זמן משוער)</span>
  </div>`;

  if (departures.length === 0) {
    html += `<div class="board-empty">
      <span class="material-symbols-rounded board-empty-icon">schedule</span>
      <span>אין יציאות שאטלים קרובים כרגע</span>
    </div>`;
  } else {
    html += `<div class="board-list">`;
    departures.forEach((dep) => {
      const urgentClass = dep.diff <= 5 ? " board-row-urgent" : "";
      const routeColor =
        dep.view === "train"
          ? "#1565c0"
          : dep.view === "tzomet"
            ? "#00695c"
            : dep.view === "internal"
              ? "#2e7d32"
              : dep.view === "hada"
                ? "#bf360c"
                : "#6a1b9a";
      html += `<div class="board-row${urgentClass}" onclick="navigateTo('${dep.view}', { highlightTime: '${dep.time}' })">
        <div class="board-row-right">
          <span class="board-row-vehicle material-symbols-rounded">airport_shuttle</span>
          <span class="board-row-time-dot" style="color:${routeColor}">${esc(dep.time)}</span>
          <span class="board-row-route">${esc(dep.routeLabel)}</span>
        </div>
        <div class="board-row-left">
          <span class="board-row-mins">${formatMinutes(dep.diff)}</span>
        </div>
      </div>`;
    });
    html += `</div>`;
  }

  html += `</div>`;
  return html;
}

// ─── Render Nav Buttons ───
function renderNavButtons() {
  const buttons = [
    {
      icon: '<span class="material-symbols-rounded">train</span>',
      label: "בסיס - רכבת כפר יהושע",
      sub: "נסיעות לרכבת הגלילים",
      view: "train",
      iconClass: "nav-btn-icon-wrap--train",
    },
    {
      icon: '<span class="material-symbols-rounded">alt_route</span>',
      label: "צומת - בסיס",
      sub: "שאטל מהצומת לבסיס",
      view: "tzomet",
      iconClass: "nav-btn-icon-wrap--tzomet",
    },
    {
      icon: '<span class="material-symbols-rounded">directions_bus</span>',
      label: "פיזור למקומות עבודה",
      sub: "הסעות פנים בסיס",
      view: "internal",
      iconClass: "nav-btn-icon-wrap--internal",
    },
    {
      icon: '<span class="material-symbols-rounded">restaurant</span>',
      label: 'חד"א',
      sub: "נסיעות לחדר האוכל",
      view: "hada",
      iconClass: "nav-btn-icon-wrap--hada",
    },
    {
      icon: '<span class="material-symbols-rounded">call</span>',
      label: "שאטל לפי קריאה",
      sub: "הזמנת נסיעה",
      view: "oncall",
      iconClass: "nav-btn-icon-wrap--oncall",
    },
    {
      icon: '<span class="material-symbols-rounded">map</span>',
      label: "מקרא תחנות ומידע",
      sub: "מפה ומידע כללי",
      view: "info",
      iconClass: "nav-btn-icon-wrap--info",
    },
  ];

  let html = `<div class="nav-card">`;
  html += `<div class="nav-card-brand">
    <div class="nav-card-brand-text">
      <div class="nav-card-brand-title">אפליקציית השאטלים</div>
      <div class="nav-card-brand-sub">בסיס כנף 1 — רמת דוד</div>
    </div>
  </div>`;
  html += `<div class="nav-card-cta">
    <span class="material-symbols-rounded nav-card-title-icon">explore</span>
    <h2 class="nav-card-title">לאן את.ה צריך להגיע?</h2>
  </div>`;
  html += `<div class="nav-buttons">`;
  buttons.forEach((btn) => {
    html += `<div class="nav-btn" onclick="navigateTo('${btn.view}')">
      <div class="nav-btn-icon-wrap ${btn.iconClass}">
        <span class="nav-btn-icon">${btn.icon}</span>
      </div>
      <div class="nav-btn-text">
        <span class="nav-btn-label">${esc(btn.label)}</span>
        <span class="nav-btn-sub">${esc(btn.sub)}</span>
      </div>
    </div>`;
  });
  html += `</div></div>`;
  return html;
}

// ─── Render Home Page ───
function renderHomePage() {
  let html = "";
  html += renderDepartureBoard();
  html += renderNavButtons();
  return html;
}

// ─── Render Top Tabs ───
function renderTopTabs() {
  const tabs = [
    { icon: "home", label: "בית", view: "home" },
    { icon: "train", label: "רכבת", view: "train" },
    { icon: "alt_route", label: "צומת", view: "tzomet" },
    { icon: "directions_bus", label: "פנים כנף", view: "internal" },
    { icon: "restaurant", label: 'חד"א', view: "hada" },
    { icon: "call", label: "לפי קריאה", view: "oncall" },
    { icon: "info", label: "מידע", view: "info" },
  ];

  let html = `<div class="top-tabs">`;
  tabs.forEach((tab) => {
    const active = tab.view === currentView ? " top-tab-active" : "";
    html += `<button class="top-tab${active}" onclick="navigateTo('${tab.view}')">
      <span class="material-symbols-rounded top-tab-icon">${tab.icon}</span>
      <span class="top-tab-label">${tab.label}</span>
    </button>`;
  });
  html += `</div>`;
  return html;
}

// ─── Render Route Content (for spoke pages) ───
function renderRouteContent(view) {
  let html = "";

  if (view === "train") {
    const toTrain = DATA.bus_routes[0];
    const fromTrain = DATA.bus_routes[1];
    html += renderRouteCard(toTrain, { splitReinforcement: true });
    html += renderRouteCard(fromTrain, { splitReinforcement: true });
  } else if (view === "tzomet") {
    const tzomet = DATA.bus_routes[3];
    html += renderRouteCard(tzomet, { hideEvening: true });
  } else if (view === "internal") {
    const internal = DATA.bus_routes[2];
    if (internal.note) {
      html += `<div class="route-note top-note">${infoSVG} ${esc(internal.note)}</div>`;
    }
    if (internal.sub_routes) {
      internal.sub_routes.forEach((sub) => {
        html += renderRouteCard(sub);
      });
    }
  } else if (view === "hada") {
    html += renderHadaContent();
  } else if (view === "oncall") {
    html += renderOnCallContent();
  } else if (view === "info") {
    html += renderInfoContent();
  }

  return html;
}

// ─── Navigate To ───
function navigateTo(view, opts) {
  opts = opts || {};
  currentView = view;
  highlightTime = opts.highlightTime || null;
  renderCurrentView();
}

// ─── Render Current View (master renderer) ───
function renderCurrentView() {
  const container = document.getElementById("app-content");
  const nav = document.getElementById("main-nav");

  nav.innerHTML = renderTopTabs();

  if (currentView === "home") {
    container.parentElement.classList.add("content-home");
    container.innerHTML = renderHomePage();
    window.scrollTo({ top: 0, behavior: "smooth" });
  } else {
    container.parentElement.classList.remove("content-home");
    container.innerHTML = renderRouteContent(currentView);

    if (currentView === "info") attachOldRouteTabListeners();

    // Highlight specific time if navigating from board
    if (highlightTime) {
      requestAnimationFrame(() => {
        const timeToFind = highlightTime;
        highlightTime = null;
        // Find dep-time-item or dep-chip-time matching the time
        const allTimeEls = container.querySelectorAll(
          ".dep-time-item, .dep-chip-time, .card-block-title, .sched-time",
        );
        for (const el of allTimeEls) {
          if (el.textContent.trim() === timeToFind) {
            el.classList.add("dep-time-highlight");
            el.scrollIntoView({ behavior: "smooth", block: "center" });
            setTimeout(() => el.classList.remove("dep-time-highlight"), 3000);
            break;
          }
        }
      });
    } else {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  }
}

// ─── חד"א (Cafeteria) Direction Data ───
function classifyHadaArea(stops) {
  const s = stops.join(" ");
  if (s.includes("גף מנועים")) return "maintenance";
  if (s.includes("גף טיסה 109") || s.includes("גף טכני 109")) return "109";
  return "105";
}

function getHadaTrips() {
  const groups = { 105: [], 109: [], maintenance: [] };
  OLD_ROUTES.forEach((route) => {
    route.schedule.forEach((entry) => {
      if (entry.type !== "נסיעה" || !entry.stops) return;
      const first = entry.stops[0];
      const last = entry.stops[entry.stops.length - 1];
      if (!isHadaStop(first) && !isHadaStop(last)) return;
      const area = classifyHadaArea(entry.stops);
      groups[area].push({ time: entry.time, stops: entry.stops });
    });
  });
  const parseTime = (t) => {
    const m = t.match(/^(\d{1,2}):(\d{2})$/);
    return m ? parseInt(m[1]) * 60 + parseInt(m[2]) : 9999;
  };
  for (const key of Object.keys(groups)) {
    groups[key].sort((a, b) => parseTime(a.time) - parseTime(b.time));
  }
  return groups;
}

function renderHadaCard(title, trips) {
  if (trips.length === 0) return "";

  const upcoming = getUpcomingFromTimes(trips.map((t) => t.time));
  const countdown = renderCountdownFromUpcoming(upcoming);

  let html = `<div class="route-card">
    <div class="route-card-header">
      <div class="route-card-title">${title}</div>
    </div>
    ${countdown}
    <div class="route-card-body">`;

  trips.forEach((trip) => {
    const passed = isTimePassed(trip.time) ? " trip-passed" : "";
    const stopsHtml = trip.stops
      .map((stop, i) => {
        const hada = isHadaStop(stop) ? " stop-hada" : "";
        return `<div class="stop-item${hada}"><span class="stop-num">${i + 1}</span>${esc(stop)}</div>`;
      })
      .join("");
    html += `
      <div class="card-block stops-block${passed}" onclick="this.classList.toggle('open')">
        <div class="card-block-header">
          <div class="card-block-title">${mapPinSVG} ${esc(trip.time)} <span class="estimated-tag">משוער</span></div>
          <div class="card-block-meta">
            <span class="stop-count-badge">${trip.stops.length} תחנות</span>
            ${smallChevronSVG}
          </div>
        </div>
        <div class="card-block-body">
          <div class="stops-list">${stopsHtml}</div>
        </div>
      </div>`;
  });

  html += `</div></div>`;
  return html;
}

function renderHadaContent() {
  const groups = getHadaTrips();
  let html = "";

  html += renderHadaCard('חד"א - כיוון 105', groups["105"]);
  html += renderHadaCard('חד"א - כיוון 109', groups["109"]);
  html += renderHadaCard('חד"א - טייסת תחזוקה', groups.maintenance);

  return html;
}

// ─── On-Call Shuttle ───
function renderOnCallContent() {
  let html = "";
  const tzomet = DATA.bus_routes[3];

  // Evening hours from tzomet route
  if (tzomet.evening) {
    html += `<div class="route-card">
      <div class="route-card-header">
        <div class="route-card-title">שאטל לפי קריאה - ערב</div>
      </div>
      <div class="route-card-body">
        <div class="card-block evening-block">
          <div class="card-block-header static">
            <div class="card-block-title">${moonSVG} שעות פעילות <span class="estimated-tag">משוערות</span></div>
          </div>
          <div class="evening-info">
            <div class="dep-chip dep-chip--evening">
              <span class="dep-chip-time">${esc(tzomet.evening.time)}</span>
            </div>
            <div class="evening-note">${esc(tzomet.evening.break)}</div>
          </div>
        </div>
        <div class="route-note">${infoSVG}   הזמנת שאטל - מבצעים/הטסה בתיאום מול מוצב מנהלה</div>
      </div>
    </div>`;
  }

  return html;
}

// ─── Old Routes ───
let activeOldRoute = "kav1";

function renderOldRouteTabsHtml() {
  const tabs = OLD_ROUTES.map((r, i) => {
    const id = `kav${i + 1}`;
    const label = r.name.split(" - ")[0];
    return `<button class="route-tab ${id === activeOldRoute ? "active" : ""}" data-oldroute="${id}">${esc(label)}</button>`;
  }).join("");
  return `<div class="route-tabs" id="oldroute-tabs">${tabs}</div>`;
}

function isHadaStop(name) {
  return name.includes('חד"א') || name.includes('חד"א');
}

function renderScheduleEntry(entry) {
  const timeHtml = `<span class="sched-time">${esc(entry.time)}</span>`;

  if (entry.type === "הפסקה") {
    return `<div class="sched-entry sched-break">
      ${timeHtml}
      <span class="sched-type-badge sched-badge-break">הפסקה</span>
    </div>`;
  }

  if (entry.type === "סוף יום") {
    return `<div class="sched-entry sched-end">
      ${timeHtml}
      <span class="sched-type-badge sched-badge-end">סוף יום</span>
    </div>`;
  }

  if (entry.type === "איסוף") {
    return `<div class="sched-entry sched-pickup">
      ${timeHtml}
      <span class="sched-type-badge sched-badge-pickup">איסוף</span>
      ${entry.description ? `<span class="sched-desc">${esc(entry.description)}</span>` : ""}
    </div>`;
  }

  if (entry.type === "נסיעה" && entry.stops) {
    const stopsHtml = entry.stops
      .map((stop, i) => {
        const hada = isHadaStop(stop) ? " stop-hada" : "";
        return `<div class="stop-item${hada}"><span class="stop-num">${i + 1}</span>${esc(stop)}</div>`;
      })
      .join("");

    return `<div class="sched-entry sched-trip">
      <div class="sched-trip-header" onclick="this.parentElement.classList.toggle('open')">
        ${timeHtml}
        <span class="sched-type-badge sched-badge-trip">נסיעה</span>
        <span class="sched-stop-count">${entry.stops.length} תחנות</span>
        ${smallChevronSVG}
      </div>
      <div class="sched-trip-stops">
        <div class="stops-list">${stopsHtml}</div>
      </div>
    </div>`;
  }

  return "";
}

function renderOldRouteContentHtml() {
  const idx = parseInt(activeOldRoute.replace("kav", "")) - 1;
  const route = OLD_ROUTES[idx];
  if (!route) return "";

  const scheduleHtml = route.schedule
    .map((entry) => renderScheduleEntry(entry))
    .join("");

  return `
    <div class="route-card">
      <div class="route-card-header">
        <div class="route-card-title">${esc(route.name)}</div>
      </div>
      <div class="route-card-body">
        <div class="schedule-timeline-note"><span class="estimated-tag">* זמנים משוערים</span></div>
        <div class="schedule-timeline">
          ${scheduleHtml}
        </div>
      </div>
    </div>`;
}

// ─── Info Tab (stations legend + old routes) ───
function renderInfoContent() {
  let html = "";

  // Stations legend
  html += `<div class="info-section">
    <h2 class="info-section-title">מקרא תחנות הכנף</h2>
    <div class="legend">
      <span class="legend-item">
        <span class="badge badge-service"></span>
        תחנת שירות - תחנה ששאטל עוצר בה
      </span>
      <span class="legend-item">
        <span class="badge badge-alt"></span>
        תחנה חלופית - תחנה שממנה נדרש להגיע לתחנת שירות
      </span>
    </div>
    <div class="stations-grid">${renderStationsHtml()}</div>
  </div>`;

  // Old routes
  html += `<div class="info-section">
    <h2 class="info-section-title">קויי שאטל</h2>
    ${renderOldRouteTabsHtml()}
    <div id="oldroute-content" class="route-content">${renderOldRouteContentHtml()}</div>
  </div>`;

  return html;
}

function attachOldRouteTabListeners() {
  const container = document.getElementById("oldroute-tabs");
  if (!container) return;
  container.addEventListener("click", (e) => {
    const btn = e.target.closest(".route-tab");
    if (!btn) return;
    activeOldRoute = btn.dataset.oldroute;
    container
      .querySelectorAll(".route-tab")
      .forEach((t) => t.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("oldroute-content").innerHTML =
      renderOldRouteContentHtml();
  });
}

// ─── Countdown Timer ───
let countdownTimer = null;

function refreshContent() {
  if (currentView === "info") return;
  renderCurrentView();
}

function startCountdownTimer() {
  stopCountdownTimer();
  const now = new Date();
  const msToNextMinute = (60 - now.getSeconds()) * 1000 - now.getMilliseconds();
  countdownTimer = setTimeout(function tick() {
    refreshContent();
    countdownTimer = setInterval(refreshContent, 60000);
  }, msToNextMinute);
}

function stopCountdownTimer() {
  if (countdownTimer) {
    clearTimeout(countdownTimer);
    clearInterval(countdownTimer);
    countdownTimer = null;
  }
}

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    renderCurrentView();
    startCountdownTimer();
  } else {
    stopCountdownTimer();
  }
});

window.addEventListener("focus", () => {
  renderCurrentView();
});

// ─── Init ───
document.addEventListener("DOMContentLoaded", async () => {
  try {
    const res = await fetch("/api/data?t=" + new Date().getTime());
    if (res.ok) {
      const dbData = await res.json();
      if (dbData.units) DATA.units = dbData.units;
      if (dbData.bus_routes) DATA.bus_routes = dbData.bus_routes;
      if (dbData.old_routes) OLD_ROUTES = dbData.old_routes;
    }
  } catch (e) {
    console.error("Failed to load data from API, using fallback", e);
  }
  renderCurrentView();
  startCountdownTimer();
});
