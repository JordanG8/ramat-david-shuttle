import"./app-mCka9DZm.js";(function(){var B="shuttle_admin_data";function b(e){return JSON.parse(JSON.stringify(e))}function l(e){if(e==null)return"";var a=document.createElement("div");return a.textContent=String(e),a.innerHTML.replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function d(e){return document.getElementById(e)}var c=b(DATA.units),o=b(DATA.bus_routes),u=b(typeof OLD_ROUTES<"u"?OLD_ROUTES:[]),T=!1,k=!1,O=!1;async function F(){try{return(await fetch("/api/verify")).ok}catch{return!1}}async function Y(e){try{return(await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:e})})).ok}catch(a){return console.error("Login error",a),!1}}async function x(){try{await fetch("/api/logout",{method:"POST"})}catch(e){console.error("Logout error",e)}location.reload()}var R=d("login-screen"),q=d("dashboard");F().then(e=>{e?(R.style.display="none",q.style.display="flex",I()):(R.style.display="flex",q.style.display="none")}),d("login-form").addEventListener("submit",async function(e){e.preventDefault();var a=d("pwd-input"),t=d("login-btn");t.disabled=!0,t.textContent="מתחבר...";var n=await Y(a.value);t.disabled=!1,t.textContent="כניסה למערכת",n?(R.style.display="none",q.style.display="flex",I()):(d("login-error").classList.add("visible"),a.value="",a.focus())}),d("logout-btn").addEventListener("click",x);async function I(){const e=await L();e&&e.units&&(c=b(e.units),DATA.units=b(e.units)),e&&e.bus_routes&&(o=b(e.bus_routes),DATA.bus_routes=b(e.bus_routes)),e&&e.old_routes&&(u=b(e.old_routes),typeof OLD_ROUTES<"u"&&(OLD_ROUTES=b(e.old_routes))),G(),w(),g(),A(),E(),et(),_()}function G(){var e=document.querySelectorAll(".adm-tab-btn");e.forEach(function(a){a.addEventListener("click",function(){e.forEach(function(t){t.classList.remove("active")}),a.classList.add("active"),document.querySelectorAll(".tab-panel").forEach(function(t){t.classList.remove("active")}),d("tab-"+a.getAttribute("data-tab")).classList.add("active")})})}function p(e,a){var t=d("toast-container"),n=document.createElement("div");n.className="toast "+(a||""),n.textContent=e,t.appendChild(n),setTimeout(function(){n.style.opacity="0",n.style.transform="translateY(12px)",n.style.transition="all .25s",setTimeout(function(){n.remove()},300)},2500)}function _(){var e=d("save-status");T||k||O?(e.textContent="שינויים שלא נשמרו",e.style.background="rgba(239,68,68,.8)",e.style.borderColor="rgba(239,68,68,.4)"):(e.textContent="הכל שמור",e.style.background="rgba(34,197,94,.25)",e.style.borderColor="rgba(34,197,94,.3)")}function v(e){e==="units"&&(T=!0),e==="routes"&&(k=!0),e==="schedules"&&(O=!0),_()}async function L(){try{const e=await fetch("/api/data?t="+new Date().getTime());return e.ok?await e.json():{}}catch(e){return console.error("Error loading data",e),{}}}async function K(){var e=await L();e.units=c,e._saved_at=new Date().toISOString(),await D(e),DATA.units=b(c),T=!1,_()}async function V(){var e=await L();e.bus_routes=o,e._saved_at=new Date().toISOString(),await D(e),DATA.bus_routes=b(o),k=!1,_()}async function $(){var e=await L();e.old_routes=u,e._saved_at=new Date().toISOString(),await D(e),typeof OLD_ROUTES<"u"&&(OLD_ROUTES=b(u)),O=!1,_()}async function z(){var e={units:c,bus_routes:o,old_routes:u,_saved_at:new Date().toISOString()};await D(e),DATA.units=b(c),DATA.bus_routes=b(o),typeof OLD_ROUTES<"u"&&(OLD_ROUTES=b(u)),T=k=O=!1,_()}async function D(e){try{const a=await fetch("/api/data",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:e})});a.ok||(a.status===401&&x(),p("שגיאה בשמירת הנתונים","error"))}catch(a){console.error("Error saving data",a),p("שגיאה בשמירת הנתונים","error")}}var j='<svg class="chevron-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>';function w(){var e=d("units-list");if(!c.length){e.innerHTML='<div class="empty-state">אין יחידות. לחץ "+ הוסף יחידה" כדי להתחיל.</div>';return}e.innerHTML=c.map(function(a,t){var n=a.color||"#274068",s=a.departments?a.departments.length:0,r=(a.departments||[]).map(function(i,f){var h=i.type==="תחנת שירות";return'<div class="dept-editor-item"><div class="dept-type-dot '+(h?"service":"alt")+'"></div><div class="dept-editor-fields"><div class="dept-editor-row"><input class="form-control" style="flex:1" value="'+l(i.name)+'" data-f="dn" data-u="'+t+'" data-d="'+f+'" placeholder="שם מחלקה"><select class="form-control" style="width:140px" data-f="dt" data-u="'+t+'" data-d="'+f+'"><option value="תחנת שירות"'+(h?" selected":"")+'>תחנת שירות</option><option value="תחנה חלופית"'+(h?"":" selected")+'>תחנה חלופית</option></select><input class="form-control" style="width:140px" value="'+l(i.goes_to||"")+'" data-f="dg" data-u="'+t+'" data-d="'+f+'" placeholder="מפנה ל..."><button class="btn btn-danger btn-sm btn-icon" data-act="del-dept" data-u="'+t+'" data-d="'+f+'" title="מחק">✕</button></div></div></div>'}).join("");return'<div class="unit-editor-card'+(t===0?" open":"")+'"><div class="unit-editor-header"><div class="unit-editor-name"><div class="unit-color-swatch" style="background:'+l(n)+'"></div><span>'+l(a.name)+'</span></div><div class="unit-editor-meta"><span class="dept-count-badge">'+s+" מחלקות</span>"+j+'</div></div><div class="unit-editor-body"><div class="form-row"><div class="form-group"><label>שם יחידה</label><input class="form-control" value="'+l(a.name)+'" data-f="un" data-u="'+t+'"></div><div class="form-group"><label>תחנת ברירת מחדל</label><input class="form-control" value="'+l(a.station||"")+'" data-f="us" data-u="'+t+'" placeholder="רחבת היסעים..."></div></div><div class="form-row"><div class="form-group"><label>צבע יחידה</label><div class="color-picker-wrap"><input type="color" value="'+l(n)+'" data-f="uc" data-u="'+t+'"><span class="text-muted text-sm">'+l(n)+'</span></div></div><div class="form-group"><label>הערה 1</label><input class="form-control" value="'+l(a.notes||"")+'" data-f="un1" data-u="'+t+'" placeholder="הערה..."></div></div><div class="form-row single"><div class="form-group"><label>הערה 2</label><input class="form-control" value="'+l(a.notes2||"")+'" data-f="un2" data-u="'+t+'" placeholder="הערה נוספת..."></div></div><hr class="divider"><div class="flex-between"><strong class="text-sm">מחלקות ('+s+')</strong></div><div class="dept-editor-list">'+r+'</div><div class="add-item-row"><button class="btn btn-secondary btn-sm" data-act="add-dept" data-u="'+t+'">+ הוסף מחלקה</button><button class="btn btn-danger btn-sm" data-act="del-unit" data-u="'+t+'" style="margin-right:auto">מחק יחידה</button></div></div></div>'}).join(""),Q(e)}function Q(e){e.querySelectorAll(".unit-editor-header").forEach(function(a){a.addEventListener("click",function(){a.parentElement.classList.toggle("open")})}),e.addEventListener("input",function(a){var t=a.target,n=t.getAttribute("data-f");if(n){var s=+t.getAttribute("data-u"),r=t.getAttribute("data-d");if(r=r!=null?+r:-1,n==="un"&&(c[s].name=t.value,t.closest(".unit-editor-card").querySelector(".unit-editor-name span").textContent=t.value),n==="us"&&(c[s].station=t.value||void 0),n==="uc"){c[s].color=t.value;var i=t.closest(".unit-editor-card");i.querySelector(".unit-color-swatch").style.background=t.value,i.querySelector(".color-picker-wrap .text-muted").textContent=t.value}n==="un1"&&(c[s].notes=t.value||void 0),n==="un2"&&(c[s].notes2=t.value||void 0),n==="dn"&&r>=0&&(c[s].departments[r].name=t.value),n==="dg"&&r>=0&&(c[s].departments[r].goes_to=t.value||void 0),v("units")}}),e.addEventListener("change",function(a){var t=a.target,n=t.getAttribute("data-f");if(n==="dt"){var s=+t.getAttribute("data-u"),r=+t.getAttribute("data-d");c[s].departments[r].type=t.value,t.closest(".dept-editor-item").querySelector(".dept-type-dot").className="dept-type-dot "+(t.value==="תחנת שירות"?"service":"alt"),v("units")}n==="uc"&&v("units")}),e.addEventListener("click",function(a){var t=a.target.closest("[data-act]");if(t){var n=t.getAttribute("data-act"),s=+t.getAttribute("data-u"),r=t.getAttribute("data-d");if(r=r!=null?+r:-1,n==="add-dept"&&(c[s].departments.push({name:"מחלקה חדשה",type:"תחנת שירות"}),v("units"),w(),N(s)),n==="del-dept"&&r>=0){if(!confirm('למחוק את "'+c[s].departments[r].name+'"?'))return;c[s].departments.splice(r,1),v("units"),w(),N(s)}if(n==="del-unit"){if(!confirm('למחוק את היחידה "'+c[s].name+'" וכל המחלקות?'))return;c.splice(s,1),v("units"),w()}}})}function N(e){var a=d("units-list").querySelectorAll(".unit-editor-card");a[e]&&a[e].classList.add("open")}d("add-unit-btn").addEventListener("click",function(){c.push({name:"יחידה חדשה",color:"#274068",departments:[]}),v("units"),w();var e=d("units-list").querySelectorAll(".unit-editor-card"),a=e[e.length-1];a&&(a.classList.add("open"),a.scrollIntoView({behavior:"smooth",block:"center"}))}),d("save-units-btn").addEventListener("click",async function(){await K(),p("יחידות ותחנות נשמרו בהצלחה!","success"),E()});function g(){var e=d("routes-list");if(!o.length){e.innerHTML='<div class="empty-state">אין קווי שאטל.</div>';return}e.innerHTML=o.map(function(a,t){var n=a.sub_routes&&a.sub_routes.length>0,s=a.stops?a.stops.length:0,r=0;a.departure_times?r=a.departure_times.length:a.departure_times_str&&(r=a.departure_times_str.split("-").length);var i="";i+='<div class="form-row"><div class="form-group"><label>שם הקו</label><input class="form-control" value="'+l(a.name)+'" data-f="rn" data-r="'+t+'"></div><div class="form-group"><label>תיאור</label><input class="form-control" value="'+l(a.description||"")+'" data-f="rd" data-r="'+t+'"></div></div>',a.note!=null&&(i+='<div class="form-row single"><div class="form-group"><label>הערה</label><input class="form-control" value="'+l(a.note)+'" data-f="rno" data-r="'+t+'"></div></div>'),n?(i+=a.sub_routes.map(function(h,m){return W(t,m,h)}).join(""),i+='<div class="add-item-row"><button class="btn btn-secondary btn-sm" data-act="add-sub" data-r="'+t+'">+ הוסף תת-מסלול</button></div>'):(a.stops&&(i+=J(t,-1,a.stops)),a.departure_times?i+=X(t,a.departure_times):a.departure_times_str!==void 0&&(i+=M(t,-1,a.departure_times_str)),a.evening&&(i+='<div class="route-subsection mt-12"><div class="route-subsection-header">לוח ערב</div><div class="route-subsection-body"><div class="form-row"><div class="form-group"><label>שעות ערב</label><input class="form-control" value="'+l(a.evening.time)+'" data-f="ret" data-r="'+t+'" style="direction:ltr;text-align:left"></div><div class="form-group"><label>הפסקה</label><input class="form-control" value="'+l(a.evening.break||"")+'" data-f="reb" data-r="'+t+'" style="direction:ltr;text-align:left"></div></div></div></div>'));var f=n?a.sub_routes.length+" תת-מסלולים":s+" תחנות · "+r+" יציאות";return'<div class="route-editor-card'+(t===0?" open":"")+'"><div class="route-editor-header"><div class="route-editor-title"><span class="route-badge">'+(t+1)+"</span><span>"+l(a.name)+'</span></div><div class="unit-editor-meta"><span class="dept-count-badge">'+f+"</span>"+j+'</div></div><div class="route-editor-body">'+i+"</div></div>"}).join(""),Z(e)}function W(e,a,t){return'<div class="route-subsection mt-8"><div class="route-subsection-header"><span>'+l(t.name)+'</span><button class="btn btn-danger btn-sm btn-icon" data-act="del-sub" data-r="'+e+'" data-s="'+a+'" title="מחק">✕</button></div><div class="route-subsection-body"><div class="form-row single"><div class="form-group"><label>שם תת-מסלול</label><input class="form-control" value="'+l(t.name)+'" data-f="sn" data-r="'+e+'" data-s="'+a+'"></div></div>'+M(e,a,t.departure_times_str||"")+J(e,a,t.stops||[])+"</div></div>"}function J(e,a,t){var n=a>=0?' data-s="'+a+'"':"",s=t.map(function(r,i){return'<div class="stop-editor-item"><span class="stop-num-badge">'+(i+1)+'</span><input class="form-control" style="flex:1" value="'+l(r)+'" data-f="stp" data-r="'+e+'"'+n+' data-i="'+i+'"><div class="stop-move-btns"><button class="stop-move-btn" data-act="stop-up" data-r="'+e+'"'+n+' data-i="'+i+'">▲</button><button class="stop-move-btn" data-act="stop-dn" data-r="'+e+'"'+n+' data-i="'+i+'">▼</button></div><button class="btn btn-danger btn-sm btn-icon" data-act="del-stp" data-r="'+e+'"'+n+' data-i="'+i+'">✕</button></div>'}).join("");return'<div class="route-subsection mt-8"><div class="route-subsection-header"><span>תחנות עצירה ('+t.length+')</span><button class="btn btn-secondary btn-sm" data-act="add-stp" data-r="'+e+'"'+n+'>+ תחנה</button></div><div class="route-subsection-body"><div class="stops-editor-list">'+s+"</div></div></div>"}function X(e,a){var t=a.map(function(n,s){var r=n.note&&n.note.indexOf("תגבור")>=0;return'<div class="time-chip'+(r?" reinforce":"")+'"><input type="time" value="'+l(n.time)+'" data-f="tv" data-r="'+e+'" data-t="'+s+'"><button class="time-chip-reinforce-toggle" data-act="tog-rein" data-r="'+e+'" data-t="'+s+'" title="תגבור">ת</button><button class="time-chip-del" data-act="del-tm" data-r="'+e+'" data-t="'+s+'">✕</button></div>'}).join("");return'<div class="route-subsection mt-8"><div class="route-subsection-header"><span>שעות יציאה ('+a.length+')</span><button class="btn btn-secondary btn-sm" data-act="add-tm" data-r="'+e+'">+ שעה</button></div><div class="route-subsection-body"><div class="times-editor-list">'+t+"</div></div></div>"}function M(e,a,t){var n=a>=0?' data-s="'+a+'"':"";return'<div class="route-subsection mt-8"><div class="route-subsection-header">שעות יציאה (טקסט)</div><div class="route-subsection-body"><div class="form-group"><label>שעות מופרדות ב-</label><input class="form-control" value="'+l(t)+'" data-f="tstr" data-r="'+e+'"'+n+' style="direction:ltr;text-align:left" placeholder="7:20-8:20-09:00..."></div></div></div>'}function S(e,a){return a>=0?o[e].sub_routes[a]:o[e]}function Z(e){e.querySelectorAll(".route-editor-header").forEach(function(a){a.addEventListener("click",function(){a.parentElement.classList.toggle("open")})}),e.addEventListener("input",function(a){var t=a.target,n=t.getAttribute("data-f");if(n){var s=+t.getAttribute("data-r"),r=t.getAttribute("data-s");if(r=r!=null?+r:-1,n==="rn"&&(o[s].name=t.value,t.closest(".route-editor-card").querySelector(".route-editor-title > span:last-child").textContent=t.value),n==="rd"&&(o[s].description=t.value||void 0),n==="rno"&&(o[s].note=t.value||void 0),n==="ret"&&(o[s].evening||(o[s].evening={}),o[s].evening.time=t.value),n==="reb"&&(o[s].evening||(o[s].evening={}),o[s].evening.break=t.value),n==="sn"&&r>=0&&(o[s].sub_routes[r].name=t.value),n==="stp"){var i=S(s,r);i.stops&&(i.stops[+t.getAttribute("data-i")]=t.value)}if(n==="tstr"&&(S(s,r).departure_times_str=t.value),n==="tv"){var f=+t.getAttribute("data-t");o[s].departure_times&&(o[s].departure_times[f].time=t.value)}v("routes")}}),e.addEventListener("click",function(a){var t=a.target.closest("[data-act]");if(t){var n=t.getAttribute("data-act"),s=+t.getAttribute("data-r"),r=t.getAttribute("data-s");r=r!=null?+r:-1;var i=t.getAttribute("data-i");i=i!=null?+i:-1;var f=t.getAttribute("data-t");if(f=f!=null?+f:-1,n==="add-stp"){var h=S(s,r);h.stops||(h.stops=[]),h.stops.push("תחנה חדשה"),v("routes"),g(),y(s)}if(n==="del-stp"&&i>=0&&(S(s,r).stops.splice(i,1),v("routes"),g(),y(s)),n==="stop-up"&&i>0){var m=S(s,r).stops,H=m[i-1];m[i-1]=m[i],m[i]=H,v("routes"),g(),y(s)}if(n==="stop-dn"){var m=S(s,r).stops;if(i<m.length-1){var H=m[i+1];m[i+1]=m[i],m[i]=H,v("routes"),g(),y(s)}}if(n==="add-tm"&&(o[s].departure_times||(o[s].departure_times=[]),o[s].departure_times.push({time:"08:00"}),v("routes"),g(),y(s)),n==="del-tm"&&f>=0&&(o[s].departure_times.splice(f,1),v("routes"),g(),y(s)),n==="tog-rein"&&f>=0){var C=o[s].departure_times[f];C.note&&C.note.indexOf("תגבור")>=0?delete C.note:C.note="תגבור- רק בימי ראשון וחמישי",v("routes"),g(),y(s)}if(n==="add-sub"&&(o[s].sub_routes||(o[s].sub_routes=[]),o[s].sub_routes.push({name:"תת-מסלול חדש",departure_times_str:"",stops:[]}),v("routes"),g(),y(s)),n==="del-sub"&&r>=0){if(!confirm("למחוק תת-מסלול זה?"))return;o[s].sub_routes.splice(r,1),v("routes"),g(),y(s)}}})}function y(e){var a=d("routes-list").querySelectorAll(".route-editor-card");a[e]&&a[e].classList.add("open")}d("save-routes-btn").addEventListener("click",async function(){await V(),p("קווי שאטל נשמרו בהצלחה!","success"),E()});function P(e){return e==="נסיעה"?"trip":e==="הפסקה"?"break":e==="איסוף"?"pickup":e==="סוף יום"?"end":"trip"}function A(){var e=d("schedules-list");if(!u.length){e.innerHTML='<div class="empty-state">אין לוחות זמנים מפורטים.</div>';return}e.innerHTML=u.map(function(a,t){var n=a.schedule?a.schedule.length:0,s=(a.schedule||[]).map(function(r,i){var f="";r.stops&&r.stops.length&&(f='<div class="form-group"><label>תחנות (אחת לשורה)</label><textarea class="form-control" data-f="ss" data-r="'+t+'" data-e="'+i+'" rows="4">'+l(r.stops.join(`
`))+"</textarea></div>");var h=r.description?'<div class="form-group"><label>תיאור</label><input class="form-control" value="'+l(r.description)+'" data-f="sd" data-r="'+t+'" data-e="'+i+'"></div>':"";return'<div class="sched-entry-editor"><div class="sched-entry-header"><span class="sched-type-tag '+P(r.type)+'">'+l(r.type)+'</span><span class="sched-entry-time-display">'+l(r.time)+'</span><svg class="chevron-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:auto"><polyline points="6 9 12 15 18 9"/></svg><button class="btn btn-danger btn-sm btn-icon" data-act="del-se" data-r="'+t+'" data-e="'+i+'" title="מחק">✕</button></div><div class="sched-entry-body"><div class="form-row"><div class="form-group"><label>שעה</label><input class="form-control" value="'+l(r.time)+'" data-f="st" data-r="'+t+'" data-e="'+i+'" style="direction:ltr;text-align:left"></div><div class="form-group"><label>סוג</label><select class="form-control" data-f="sy" data-r="'+t+'" data-e="'+i+'"><option value="נסיעה"'+(r.type==="נסיעה"?" selected":"")+'>נסיעה</option><option value="הפסקה"'+(r.type==="הפסקה"?" selected":"")+'>הפסקה</option><option value="איסוף"'+(r.type==="איסוף"?" selected":"")+'>איסוף</option><option value="סוף יום"'+(r.type==="סוף יום"?" selected":"")+">סוף יום</option></select></div></div>"+h+f+'<button class="btn btn-secondary btn-sm" data-act="add-ss" data-r="'+t+'" data-e="'+i+'" style="margin-top:4px">+ הוסף תחנות</button></div></div>'}).join("");return'<div class="route-editor-card"><div class="route-editor-header"><div class="route-editor-title"><span class="route-badge">'+(t+1)+"</span><span>"+l(a.name)+'</span></div><div class="unit-editor-meta"><span class="dept-count-badge">'+n+" רשומות</span>"+j+'</div></div><div class="route-editor-body"><div class="form-row"><div class="form-group"><label>שם הקו</label><input class="form-control" value="'+l(a.name)+'" data-f="srn" data-r="'+t+'"></div><div class="form-group"><label>טלפון</label><input class="form-control" value="'+l(a.phone||"")+'" data-f="srp" data-r="'+t+'" style="direction:ltr;text-align:left"></div></div><hr class="divider"><div class="sched-editor-list">'+s+'</div><div class="add-item-row"><button class="btn btn-secondary btn-sm" data-act="add-se" data-r="'+t+'">+ הוסף רשומה</button></div></div></div>'}).join(""),tt(e)}function tt(e){e.querySelectorAll(".route-editor-header").forEach(function(a){a.addEventListener("click",function(){a.parentElement.classList.toggle("open")})}),e.querySelectorAll(".sched-entry-header").forEach(function(a){a.addEventListener("click",function(t){t.target.closest("[data-act]")||a.parentElement.classList.toggle("open")})}),e.addEventListener("input",function(a){var t=a.target,n=t.getAttribute("data-f");if(n){var s=+t.getAttribute("data-r"),r=t.getAttribute("data-e");r=r!=null?+r:-1,n==="srn"&&(u[s].name=t.value,t.closest(".route-editor-card").querySelector(".route-editor-title > span:last-child").textContent=t.value),n==="srp"&&(u[s].phone=t.value||""),n==="st"&&r>=0&&(u[s].schedule[r].time=t.value,t.closest(".sched-entry-editor").querySelector(".sched-entry-time-display").textContent=t.value),n==="sd"&&r>=0&&(u[s].schedule[r].description=t.value||void 0),n==="ss"&&r>=0&&(u[s].schedule[r].stops=t.value.split(`
`).filter(function(i){return i.trim()})),v("schedules")}}),e.addEventListener("change",function(a){var t=a.target;if(t.getAttribute("data-f")==="sy"){var n=+t.getAttribute("data-r"),s=+t.getAttribute("data-e");u[n].schedule[s].type=t.value;var r=t.closest(".sched-entry-editor").querySelector(".sched-type-tag");r.className="sched-type-tag "+P(t.value),r.textContent=t.value,v("schedules")}}),e.addEventListener("click",function(a){var t=a.target.closest("[data-act]");if(t){var n=t.getAttribute("data-act"),s=+t.getAttribute("data-r"),r=t.getAttribute("data-e");r=r!=null?+r:-1,n==="add-se"&&(u[s].schedule||(u[s].schedule=[]),u[s].schedule.push({time:"00:00",type:"נסיעה",stops:[]}),v("schedules"),A(),U(s)),n==="del-se"&&r>=0&&(u[s].schedule.splice(r,1),v("schedules"),A(),U(s)),n==="add-ss"&&r>=0&&(u[s].schedule[r].stops||(u[s].schedule[r].stops=[]),u[s].schedule[r].stops.push("תחנה חדשה"),v("schedules"),A(),U(s))}})}function U(e){var a=d("schedules-list").querySelectorAll(".route-editor-card");a[e]&&a[e].classList.add("open")}d("save-schedules-btn").addEventListener("click",async function(){await $(),p("לוחות זמנים נשמרו בהצלחה!","success"),E()});function et(){d("change-pwd-btn").addEventListener("click",async function(){var a=d("old-pwd").value,t=d("new-pwd").value,n=d("confirm-pwd").value;if(a!==getPassword()){p("סיסמה נוכחית שגויה","error");return}if(!t||t.length<4){p("סיסמה חדשה קצרה מדי (מינימום 4 תווים)","error");return}if(t!==n){p("הסיסמאות אינן תואמות","error");return}try{const s=await fetch("/api/settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"change_password",newPassword:t})});s.ok?(d("old-pwd").value=d("new-pwd").value=d("confirm-pwd").value="",p("הסיסמה עודכנה בהצלחה!","success")):(s.status===401&&x(),p("שגיאה בעדכון הסיסמה","error"))}catch(s){console.error("Error changing password",s),p("שגיאה בעדכון הסיסמה","error")}}),d("reset-btn").addEventListener("click",async function(){if(confirm("האם אתה בטוח? כל השינויים יימחקו ולא ניתן לשחזרם."))try{const a=await fetch("/api/settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"reset_data"})});a.ok?(localStorage.removeItem(B),p("הנתונים אופסו. הדף ירענן כעת...","success"),setTimeout(function(){location.reload()},1200)):(a.status===401&&x(),p("שגיאה באיפוס הנתונים","error"))}catch(a){console.error("Error resetting data",a),p("שגיאה באיפוס הנתונים","error")}}),d("export-btn").addEventListener("click",function(){var a={units:c,bus_routes:o,old_routes:u,_exported_at:new Date().toISOString()},t=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),s=document.createElement("a");s.href=n,s.download="shuttle-data-"+new Date().toISOString().slice(0,10)+".json",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n),p("נתונים יוצאו בהצלחה!","success")});var e=d("import-file");d("import-btn").addEventListener("click",function(){e.click()}),e.addEventListener("change",function(){var a=e.files[0];if(a){var t=new FileReader;t.onload=async function(n){try{var s=JSON.parse(n.target.result);s.units&&(c=s.units),s.bus_routes&&(o=s.bus_routes),s.old_routes&&(u=s.old_routes),await z(),w(),g(),A(),E(),p("נתונים יובאו בהצלחה!","success")}catch(r){p("שגיאה בקריאת הקובץ: "+r.message,"error")}},t.readAsText(a),e.value=""}})}async function E(){var e=await L(),a=c.reduce(function(s,r){return s+(r.departments?r.departments.length:0)},0),t=u.reduce(function(s,r){return s+(r.schedule?r.schedule.length:0)},0),n=e&&e.units&&e.units.length>0;d("data-info").innerHTML='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><strong>יחידות:</strong> '+c.length+"</div><div><strong>מחלקות:</strong> "+a+"</div><div><strong>קווי שאטל:</strong> "+o.length+"</div><div><strong>לוחות זמנים:</strong> "+u.length+" ("+t+" רשומות)</div><div><strong>נתונים מותאמים:</strong> "+(n?"כן":"לא — ברירת מחדל")+"</div>"+(e&&e._saved_at?"<div><strong>עדכון אחרון:</strong> "+new Date(e._saved_at).toLocaleString("he-IL")+"</div>":"")+"</div>"}})();
